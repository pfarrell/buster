<html>
  <head>
    <meta charset="utf-8"> 
    <style>
      body {
        background-color:yellow;
        height:1000px;
      }
      .tweet {
        background-color:white;
        min-width:73px;
        max-height:73px;
        min-height:73px;
      }
      .slider {
        display: inline;
      }

      
    </style>
    <script>
     function getParam(name) {
       name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
       var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"), results = regex.exec(location.search);
       return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
      } 
    </script>
  </head>
  <body>
    <div>
      <div class="slider">
        <label>Refresh Rate: </label>
        <label id="delay_lbl"></label>          
        <label>ms</label>
        <br/>
        <input type="range" name="refresh" min="5" value="300" max="1000" step="5" onchange="refreshDelay(this)"></input>
      </div>
      <label id="buffer_size"></label>
    </div>
    <div id="tweets0" class="tweet"></div>
    <div id="tweets1" class="tweet"></div>
    <div id="tweets2" class="tweet"></div>
    <div id="tweets3" class="tweet"></div>
    <div id="tweets4" class="tweet"></div>
    <div id="tweets5" class="tweet"></div>
    <div id="tweets6" class="tweet"></div>
    <div id="tweets7" class="tweet"></div>
    <div id="tweets8" class="tweet"></div>
    <script>

      var msgs = 0
      var queue = [];
      var delay = getParam("delay") || 300;
      document.getElementById("delay_lbl").innerHTML= delay;

      function update() {
        msgs += 1
        var msg = queue.shift();
        document.getElementById("buffer_size").innerHTML = "msg backlog: " + queue.length  
        if(msg != null) {
          document.getElementById("tweets" + (msgs % 9)).innerHTML = "<table><tr><td><img src='" + msg.message.user.profile_image_uri + "' /></td><td align='center'><table><tr><td><a target='_' href='http://twitter.com/" + msg.message.user.screen_name + "'>" + msg.message.user.screen_name + "</a></td></tr><tr><td>" + msg.message.text + "</td></tr></table></td></tr></table>";
          console.log(" pop:" + queue.length);
        }else {
          console.log("none: " + queue.length);
        }
        window.setTimeout(function() {update()}, delay);
      }

      function refreshDelay(elem) {
        delay=elem.value;
        document.getElementById("delay_lbl").innerHTML= delay;
      }

      var stream = new EventSource('/tweet_stream');
      stream.addEventListener('message', function(event) {
        //if(queue.length > 10) queue.pop();
        queue.push(JSON.parse(event.data));
      }, false);
      

      stream.addEventListener('open', function(e) {
          console.log(e);
          // Connection was opened.
      }, false);

      stream.addEventListener('error', function(e) {
          console.log(e);
          if (e.readyState == EventSource.CLOSED) {
                // Connection was closed.
                  }
      }, false);
      window.setTimeout(function() {update()}, delay);
    </script>
  </body>
</html>
